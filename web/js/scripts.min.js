$(document).ready(function () {

  var nowModelShow = '';

  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------
  // Страница Категории!----------------------------------------------------------------------------------------------------------------------------------------------
  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------
  class Sorting {

    sorting(){
      this.getFilterData();
      this.getQuantity();
      this.getSortData();
      this.getNewProducts();

      return true;
    }

    getNewProducts(){

      let data = this.filterData;
      data['sort'] = this.sortData;
      data.quantity = this.quantity;

      let json = JSON.stringify(data);

      $.ajax({
        url: "/shop/ajaxfilter",
        method: "GET",
        data: "data="+json,
        success: function(json){
          $('#mse2_results').remove();
          let response = JSON.parse(json);

          console.log(response);

          if(response.status === false){
            $('#mse2_results').append('<p class="no-goods">Нет подходящих товаров</p>');
            return false;
          }

          $('.products-block').append(response.newElems);

          for (let key in response.filter){
            $('#idCatVal'+key).find('input').each(function () {
              $(this).prop('disabled', false);
              let flag = false;
              for (let key2 in response.filter[key]['values']){
                if($(this).val() == key2){
                  $(this).parent('label').find('sup').text(response.filter[key]['values'][key2]);
                  flag = true;

                  return;
                }
              }
              if(!flag){
                $(this).parent('label').find('sup').text('0');
                $(this).prop('disabled', true);
              }
            })
          }
        }
      });
    }

    getQuantity(){
      let quantity = $("#prosucts-limit").val();

      this.quantity = quantity;
      return quantity;
    }

    getSortData(){
      let sortData = $("a.sort-button.active").attr('data-sort-of')+'-'+$("a.sort-button.active").attr('data-method');

      this.sortData = sortData;
      return sortData;
    }

    getFilterData(){
      let strTest = $("#filters fieldset.filter-group");

      let data = {
        'idCat': $("div.category").attr('id').replace('category-', ''),
        'min': $("input#min-price").val(),
        'max': $("input#max-price").val(),
      };

      strTest.each(function () {
        let idAttr = $(this).attr('id').replace("idCatVal", "");
        data[idAttr] = [];
        $(this).find("input:checkbox:checked").each(function () {
          data[idAttr].push($(this).attr('value'));
        })
      })

      this.filterData = data;
      return data;
    }
  }

  $("div.ps-select a.sort-button").click(function () {

    let arraySortVar = ['ASC', 'DESC'];

    let sortButtons = $("a.sort-button");
    sortButtons.each(function () {
      $(this).removeClass('active');
    })
    $(this).addClass('active');

    let nowSortVar = $(this).attr('data-method');
    if(arraySortVar[0] == nowSortVar){
      $(this).attr('data-method', arraySortVar[1]);
      // добавить переключение цвета
    }else{
      $(this).attr('data-method', arraySortVar[0]);
      // добавить переключение цвета
    }
  })

  //вызов
  $("#filters input, .products-limit, #prosucts-limit").change(sortingNow);
  $(".sort-button").click(sortingNow);

  function sortingNow() {
    var objSort = new Sorting;

    objSort.sorting();
  }

  $(document).on('click touchstart', 'div.product button.product-put-basket', function(){
    let prodIdAndVarId = $(this).attr('data-product');
    let temp = prodIdAndVarId.split('-');
    let prodId = temp[0];
    let varId = temp[1];

    $.ajax({
      url: "/request/putinbasket",
      method: "GET",
      data: "prodId="+prodId+"&varId="+varId,
      success: function(json) {
        $('span.basket-count').html(json);
      }
    });

    $('#cartDialog').show();
    $(".popup-fade").show();

    nowModelShow = $('#cartDialog');

    return false;
  });

  //Слайдер цен
  $( "div.mse2_number_slider" ).slider({
    range: true,
    min: parseInt($('#min-price').val()),
    max: parseInt($('#max-price').val()),
    values: [ parseInt($('#min-price').val()), parseInt($('#max-price').val()) ],
    slide: function( event, ui ) {
      $('#min-price').val(ui.values[ 0 ]);
      $('#max-price').val(ui.values[ 1 ]);
    },
    stop: function (event, ui) {
      sortingNow();
    }
  });
  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------
  // /Страница Категории!----------------------------------------------------------------------------------------------------------------------------------------------
  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------


  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------
  // Страница товара!--------------------------------------------------------------------------------------------------------------------------------------------------
  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------
  if($('div.product-page').length>0){
    $('.modifications input').change(function () {
      let varId = $(this).attr('id').replace('var-', '');

      veiwNeededVariation(varId);
    });

    function veiwNeededVariation(varId) {
      $('.modifications input:checked').prop('checked', false);
      $('.modifications input#var-'+varId).prop('checked', true);

      $('#variations .variation').css("display", "none");
      $('#variation-'+varId).css("display", "block");

      let prodIdAndVarId = $('button.product-put-basket').attr('data-product');
      let temp = prodIdAndVarId.split('-');
      let prodId = temp[0];
      let varIdOld = temp[1];

      $('button.product-put-basket').attr('data-product', prodId+'-'+varId);

      return false;
    }

    $("div.info button.product-put-basket").click(function () {
      let prodIdAndVarId = $(this).attr('data-product');
      let temp = prodIdAndVarId.split('-');
      let prodId = temp[0];
      let varId = temp[1];

      $.ajax({
        url: "/request/putinbasket",
        method: "GET",
        data: "prodId="+prodId+"&varId="+varId,
        success: function(count) {
          $('span.basket-count').html(count);
        }
      });

      $('#cartDialog').show();
      $(".popup-fade").show();

      nowModelShow = $('#cartDialog');

      return false;
    });

    veiwNeededVariation($('.modifications input:first-child').attr('id').replace('var-', ''));
  }

  $(".oneclick-link").click(function () {
    $('#oneclick').show();
    $(".popup-fade").show();

    nowModelShow = $('#oneclick');
  });


  $(".owl-carousel").owlCarousel({
    'items': 1,
    'loop': true
  });
  $(".owl-carousel>div>div>div>div>a").fancybox({
  });
  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------
  // /Страница товара!-------------------------------------------------------------------------------------------------------------------------------------------------
  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------


  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------
  // Страница Корзины!-------------------------------------------------------------------------------------------------------------------------------------------------
  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------
  class Basket {

    constructor(product, count){
      this.parent = product;
      this.input = $(this.parent).find('input.input-sm');
      this.price = $(this.parent).find('td.price');
      this.priceForOne = $(this.price).attr('price-for-one');
      if(count === false){
        this.newCount = $(this.input).val();
      }else {
        this.newCount = count;
      }
      this.idVar = $(this.parent).attr('var-id');
      this.idProd = $(this.parent).attr('prod-id');
    }

    changePriceProduct(){

      if(this.newCount <= 0){
        return this.deleteProd();
      }

      let newFullPrice = this.newCount*this.priceForOne;

      $(this.price).find('span').html(newFullPrice);

      this.ajax();
    }

    deleteProd(){
      this.newCount = 0;

      $(this.parent).remove();

      this.ajax();
    }

    ajax(){
      $.ajax({
        url: "/request/changebasket",
        method: "GET",
        data: "prodId="+this.idProd+"&varId="+this.idVar+'&newCount='+this.newCount,
        success: function(json) {

          if($('tr.product-in-basket').length <= 0){
            location.reload();
          }

        }
      });

      this.totalValues();
    }

    totalValues(){

      var totalCount = 0;
      var totalPrice = 0;
      $('tr.product-in-basket').each(function () {
        totalCount = totalCount + parseInt($(this).find('input.input-sm').val());
        totalPrice = totalPrice + parseInt($(this).find('td.price span').html());
      });

      $('span.total_count').html(totalCount);
      $('span.basket-count').html(totalCount);
      $('span.total_cost').html(totalPrice);
    }
  }

  function createClassBasket(elem, count = false){
    let basket = new Basket($(elem).parents('.product-in-basket'), count);
    basket.changePriceProduct();
  }

  $('.delete-product').click(function () {

    createClassBasket(this, count = 0);
    return false;
  })

  $('.product-in-basket input').change(function () {
    createClassBasket(this);
  })

  //Заказ из корзины
  $(".basket-form").submit(function () {

    $.ajax({
      url: "/request/ajaxsubmitbasket",
      method: "GET",
      data: $(this).serialize(),
      success: function(json) {

      }
    });

    return false;
  })

  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------
  // /Страница Корзины!-------------------------------------------------------------------------------------------------------------------------------------------------
  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------


  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------
  // Модальные окна-------------------------------------------------------------------------------------------------------------------------------------------------
  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------
  // Клик по ссылке "Закрыть".
  $('.popup-close').click(function() {
    $(this).parents('.popup-fade').fadeOut();
    $(nowModelShow).css({display: 'none'});
    return false;
  });

  // Закрытие по клавише Esc.
  $(document).keydown(function(e) {
    if (e.keyCode === 27) {
      e.stopPropagation();
      $(nowModelShow).css({display: 'none'});
      $('.popup-fade').fadeOut();
    }
  });

  // Клик по фону, но не по окну.
  $('.popup-fade').click(function(e) {
    if ($(e.target).closest('.popup').length == 0) {
      $(nowModelShow).css({display: 'none'});
      $(this).fadeOut();
    }
  });
  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------
  // /Модальные окна-------------------------------------------------------------------------------------------------------------------------------------------------
  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------


  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------
  // Формы-------------------------------------------------------------------------------------------------------------------------------------------------
  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------
  $('input.input-phone').inputmask("+7 (999) 999-99-99");

  $('form.ajax_form_callback').submit(function () {
    let prod_id = 0;
    let var_id = 0;
    let name = $(this).find('input.name').val();
    let phone = $(this).find('input.input-phone').val();
    let question = '';
    if($("textarea.question").length > 0){
      question = $("textarea.question").val();
    }


    if($('div.product-page').length > 0){
      let data = $('button.product-put-basket').attr('data-product').split('-');
      prod_id = data[0];
      var_id = data[1];
    }else if(!name || !phone){
      if(!name)
        $(this).find('input.name').toggleClass('error');

      if(!phone)
        $(this).find('input.input-phone').toggleClass('error');
    }


      $(this).find('input').removeClass('error');

      $.ajax({
        url: "/request/ajaxform",
        method: "GET",
        data: "name="+name+"&phone="+phone+'&prod_id='+prod_id+'&var_id='+var_id,
        success: function(json) {
          let response = JSON.parse(json);

          if (response['status']) {
            $(".popup-fade").hide();
            $('#thanks').show();
            $(nowModelShow).hide();
            nowModelShow = $('#thanks');
            $(".popup-fade").show();
          } else {
            let errors = response['errors'];
            errors.forEach(function (value) {
              if (value === 'name')
                $('input.name').toggleClass('error');

              if (value === 'phone')
                $('input.input-phone').toggleClass('error');
            });
          }
          $('input.name').val('');
          $('input.input-phone').val('');
          $("textarea.question").val('');
        }
      });

    return false;
  });

  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------
  // /Формы-------------------------------------------------------------------------------------------------------------------------------------------------
  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------


  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------
  // слайдер цены-------------------------------------------------------------------------------------------------------------------------------------------------
  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------


  /*$( "#amount" ).val( "$" + $( "#slider-range" ).slider( "values", 0 ) +
      " - $" + $( "#slider-range" ).slider( "values", 1 ) );*/
  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------
  // слайдер цены-------------------------------------------------------------------------------------------------------------------------------------------------
  //-------------------------------------------------------------------------------------------------------------------------------------------------------------------


});

//



